## Part 1. Готовый докер

В качестве конечной цели своей небольшой практики вы сразу выбрали написание докер образа для собственного веб сервера, а потому в начале вам нужно разобраться с уже готовым докер образом для сервера.
Ваш выбор пал на довольно простой nginx.

1.1 Взять официальный докер образ с nginx и выкачать его при помощи **docker pull**

1.2 Проверить наличие докер образа через **docker images**

1.3 Запустить докер образ через **docker run -d [image_id|repository]**

1.4 Проверить, что образ запустился через **docker ps**

![run nginx](./images/1.1.jpg)

1.5 Посмотреть информацию о контейнере через **docker inspect [container_id|container_name]**

- Поскольку вывод команды достаточно большой, сохраним его в текстовый файл и определим при помощи поиска в nano
  **размер контейнера**, **список замапленных портов** и **IP контейнера**

![docker inspect](./images/1.2.jpg)
![docker inspect](./images/1.3.jpg)
![docker inspect](./images/1.4.jpg)

1.6 Остановить докер образ через **docker stop [container_id|container_name]**

1.7 Проверить, что образ остановился через **docker ps**

![docker stop](./images/1.5.jpg)

1.8 Запустить докер с портами 80 и 443 в контейнере, замапленными на такие же порты на локальной машине, через команду **docker run**

1.9 Проверить, что в браузере по адресу **localhost:80** доступна стартовая страница nginx

![run with mapped ports](./images/1.6.jpg)

1.10 Перезапустить докер контейнер через **docker restart [container_id|container_name]**

1.11 Проверить любым способом, что контейнер запустился

![docker restart](./images/1.7.jpg)


## Part 2. Операции с контейнером

Докер образ и контейнер готовы. Теперь можно покопаться в конфигурации nginx и отобразить статус страницы.

- Для начала я создам новый контейнер, присвоив ему имя, чтобы в дальнейшем было удобнее

![new container](./images/2.0.jpg)

2.1 Прочитать конфигурационный файл nginx.conf внутри докер контейнера через команду **docker exec**

![read nginx.conf](./images/2.1.jpg)

2.2 Создать на локальной машине файл **nginx.conf**

2.3 Настроить в нем по пути **/status** отдачу страницы статуса сервера nginx

- За основу я беру файл **nginx.conf** из контейнера, куда дописываю: 

```c
server {
    location = /status {  // Блок конфигурации для обработки запросов к пути /status. Внутри этого блока определены настройки для обработки таких запросов.
        stub_status  // Директива, которая включает отдачу страницы статуса сервера Nginx. Так при обращении к пути /status, Nginx будет отдавать страницу со статистикой и текущим состоянием сервера.
    }:
};
```

![set /status](./images/2.2.jpg)

2.4 Скопировать созданный файл nginx.conf внутрь докер образа через команду **docker cp**

2.5 Перезапустить nginx внутри докер образа через команду **docker exec**

2.6 Проверить, что по адресу **localhost:80/status** отдается страничка со статусом сервера nginx

![nginx status](./images/2.3.jpg)

2.7 Экспортировать контейнер в файл **container.tar** через команду **export**

2.8 Остановить контейнер

  ![export and stop container](./images/2.4.jpg)

2.9 Удалить образ через **docker rmi [image_id|repository]**, не удаляя перед этим контейнеры

- Я забыла заскринить этот этап сразу и ввела команду еще раз, поэтому в выводе отображается, что образа уже нет.

2.10 Удалить остановленный контейнер

  ![delete image](./images/2.5.jpg)

2.11 Импортировать контейнер обратно через команду **docker import**

- **["nginx", "-g", "daemon off;"]** гарантирует, что Nginx останется «на переднем плане», так что Docker сможет правильно отслеживать процесс (в противном случае контейнер остановится сразу после запуска)

2.12 Запустить импортированный контейнер

2.13 Проверить, что по адресу **localhost:80/status** отдается страничка со статусом сервера nginx

![restore container](./images/2.6.jpg)


## Part 3. Мини веб-сервер

Настало время немного оторваться от докера, чтобы подготовиться к последнему этапу. Настало время написать свой сервер.

3.1 Написать мини сервер на C и FastCgi, который будет возвращать простейшую страничку с надписью Hello World!

![create server](./images/3.1.jpg)

3.2 Написать свой nginx.conf, который будет проксировать все запросы с 81 порта на 127.0.0.1:8080

![create config](./images/3.2.jpg)

3.3 Запустить написанный мини сервер через spawn-fcgi на порту 8080

- Для этого сначала запускаем контейнер с замапленным портом 81

![run container](./images/3.3.jpg)

- Далее клонируем репозиторий с server.c и nginx.conf, копируем эти файлы в контейнер

![clone and copy files](./images/3.4.jpg)

- Заходим в контейнер и устанавливаем необходимые для запуска сервера библиотеки

![install libraries](./images/3.5.jpg)

- Компилируем библиотеку, запускаем сервер и обновляемся

![run server](./images/3.6.jpg)

3.4 Проверить, что в браузере по localhost:81 отдается написанная страничка

![curl localhost:8080](./images/3.6.jpg)

3.5 Положить файл nginx.conf по пути ./nginx/nginx.conf (это понадобится позже)

## Part 4. Свой докер

Теперь всё готово. Можно приступать к написанию докер образа для созданного сервера.

4.1 Соберем свой докер.
1) собирает исходники мини сервера на FastCgi из Части 3
2) запускает его на 8080 порту
3) копирует внутрь образа написанный ./nginx/nginx.conf
4) запускает nginx.

- Сначала пишем start.sh, в котором записываем команды для ENTRYPOINT. Entrypoint в Dockerfile определяет команды, которые будут запущены при запуске контейнера из образа.

![start.sh](./images/4.1.jpg)

- Создаем Dockerfile

![dockerfile](./images/4.2.jpg)

4.2 Собрать написанный докер образ через docker build при этом указав имя и тег 

![docker build](./images/4.3.jpg)

4.3 Проверить через docker images, что все собралось корректно  

![docker images](./images/4.4.jpg)

4.4 Запустить собранный докер образ с маппингом 81 порта на 80 на локальной машине и маппингом папки ./nginx внутрь контейнера по адресу, где лежат конфигурационные файлы nginx'а (см. Часть 2)  

![run](./images/4.5.jpg)

4.5 Проверить, что по localhost:80 доступна страничка написанного мини сервера

![curl](./images/4.6.jpg)

4.6 Дописать в ./nginx/nginx.conf проксирование странички /status, по которой надо отдавать статус сервера nginx

![/status](./images/4.7.jpg)

4.7 Перезапустить докер образ

4.8 Проверить, что теперь по localhost:80/status отдается страничка со статусом nginx

![curl](./images/4.8.jpg)

## Part 5. **Dockle**

После написания образа никогда не будет лишним проверить его на безопасность.

- Скачиваем Dockle 

![dockle_installer](./images/5.1.jpg)

![install_process](./images/5.2.jpg)

5.1 Просканировать образ из предыдущего задания через `dockle [image_id|repository]`

- Для сканирования вводилась команда dockle myimage:v2 (т.е. с образом из 4 части)

![dockle](./images/5.3.jpg)

5.2 Исправить образ так, чтобы при проверке через **dockle** не было ошибок и предупреждений

- В Dockerfile был изменен USER с root на nginx
- Был добавлен HEALTHCHECK для проверок образа
- Изменены разрешения для файлов в соответствии с требованием Dockle
- Dockle не понравились ключи nginx, но нам они нужны, поэтому при вызове Dockle-проверки мы сделаем для них исключения 

![repair](./images/5.4.jpg)

![repair](./images/5.5.jpg)

## Part 6. Базовый **Docker Compose**

Вот вы и закончили вашу разминку. А хотя погодите...
Почему бы не поэкспериментировать с развёртыванием проекта, состоящего сразу из нескольких докер образов?

6.1 Написать файл *docker-compose.yml*, с помощью которого:
1) Поднять докер контейнер из 5 части _(он должен работать в локальной сети, т.е. не нужно использовать инструкцию **EXPOSE** и мапить порты на локальную машину)_
2) Поднять докер контейнер с **nginx**, который будет проксировать все запросы с 8080 порта на 81 порт первого контейнера

6.2 Замапить 8080 порт второго контейнера на 80 порт локальной машины

![docker-compose.yml](./images/6.1.jpg)

- Также создаем необходимые файлы в специально отведенной директории (docker-compose) для того, чтобы поднять nginx:

![Dockerfile](./images/6.2.jpg)

![start.sh](./images/6.3.jpg)

![nginx/nginx.conf](./images/6.4.jpg)

6.3 Остановить все запущенные контейнеры

![docker stop and rm result](./images/6.5.jpg)

6.4 Собрать и запустить проект с помощью команд `docker-compose build` и `docker-compose up`

6.5 Проверить, что в браузере по *localhost:80* отдается написанная вами страничка, как и ранее

![docker-compose build](./images/6.6.jpg)

![docker-compose up and curl](./images/6.7.jpg)
